<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
   namespace="org.spring.projectjs.jdbc.ICalendar">

   <resultMap id="PlantMap"
      type="org.spring.projectjs.jdbc.PlantDTO">
      <result column="NAME" property="name" />
      <result column="MAX_GROW_DAYS" property="max_grow_days" />
   </resultMap>

   <resultMap id="CalendarMap"
      type="org.spring.projectjs.jdbc.CalendarDTO">
      <result column="CALENDAR_IDX" property="calendar_idx" />
      <result column="MEMBER_ID" property="member_id" />
      <result column="PLANTS_NAME" property="plants_name" />
      <result column="START_DATE" property="start_date" />
      <result column="TITLE" property="title" />
      <result column="MEMO" property="memo" />
      <result column="PHOTO" property="photo" />
      <result column="COLOR" property="color" />
      <result column="REG_DATE" property="reg_date" />
      <result column="UPD_DATE" property="upd_date" />
   </resultMap>

   <select id="searchPlantName" resultMap="PlantMap">
      SELECT NAME,
      MAX_GROW_DAYS
      FROM plants
      WHERE NAME LIKE '%' || #{keyword} || '%'
   </select>

   <insert id="insertCalendar"
      parameterType="org.spring.projectjs.jdbc.CalendarDTO">
      <selectKey keyProperty="calendar_idx" resultType="int"
         order="BEFORE">
         SELECT SEQ_CALENDAR_NUM.NEXTVAL FROM dual
      </selectKey>
      INSERT INTO CALENDAR
      (CALENDAR_IDX, MEMBER_ID, PLANTS_NAME, START_DATE,
      TITLE, MEMO, COLOR, REG_DATE)
      VALUES
      (#{calendar_idx},
      #{member_id},
      #{plants_name},
      #{start_date},
      #{title},
      #{memo, jdbcType=VARCHAR},
      #{color, jdbcType=VARCHAR},
      SYSDATE)
   </insert>

   <resultMap id="EventMap"
      type="org.spring.projectjs.jdbc.CalendarDTO">
      <result column="CALENDAR_IDX" property="calendar_idx" />
      <result column="TITLE" property="title" />
      <result column="MEMO" property="memo" />
      <result column="START_DATE" property="start_date" />
      <result column="END_EXCL" property="end_date" />
      <result column="COLOR" property="color" />
      <result column="PLANTS_NAME" property="plants_name" />
   </resultMap>

   <select id="listCalendarByRange" resultMap="EventMap">
      SELECT
      c.CALENDAR_IDX,
      c.TITLE,
      c.PLANTS_NAME,
      c.START_DATE,
      (c.START_DATE + (NVL(p.MAX_GROW_DAYS, 0) + 1)) AS END_EXCL,
      c.COLOR,
      c.MEMO
      FROM CALENDAR c
      LEFT JOIN PLANTS p
      ON p.NAME = c.PLANTS_NAME
      WHERE c.MEMBER_ID = #{member_id}
      AND c.START_DATE <![CDATA[<]]> #{end}
      AND (c.START_DATE + (NVL(p.MAX_GROW_DAYS, 0) + 1)) > #{start}
      ORDER BY c.START_DATE
   </select>

   <update id="updateCalendar">
      UPDATE CALENDAR
      SET TITLE = #{title},
      MEMO = #{memo,
      jdbcType=VARCHAR},
      UPD_DATE = SYSDATE
      WHERE CALENDAR_IDX = #{id}
      AND
      MEMBER_ID = #{memberId}
   </update>

   <!-- 일정 삭제 -->
   <delete id="deleteCalendar">
      DELETE FROM CALENDAR
      WHERE CALENDAR_IDX = #{id}
      AND
      MEMBER_ID = #{memberId}
   </delete>

   <update id="updateCalendarDate">
      UPDATE CALENDAR
      SET START_DATE = #{startDate},
      'YYYY-MM-DD'),
      UPD_DATE = SYSDATE
      WHERE CALENDAR_IDX = #{id}
      AND
      MEMBER_ID = #{memberId}
   </update>
</mapper>